<!DOCTYPE html>
<html>
  <head>

    <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/dist/styles/ag-grid.css">
    <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/dist/styles/ag-theme-alpine.css">
    <script src="https://unpkg.com/ag-grid-community/dist/ag-grid-community.min.noStyle.js"></script>
    <style>
      body {
        font-family: Verdana, Geneva, Tahoma, sans-serif;
      }
      .inout {
        margin: 1rem;
        padding: 2rem 2rem;
        text-align: center;
        height: 150px;
      }
      .top {
        display: inline-block;
        padding: 1rem 1rem;
        vertical-align: middle;
        height: 149px;
        overflow-x: auto;
      }

    #debug {
      width:200px;
      max-width: 200px;
      font-size:10px;
      
    }
  </style>
</head>

<body>
<div id="inout">
  <div id="in" class="top">
    <textarea id="input" rows="4" cols="40">
      #;SEARCH:;';;;;;;;
#;DESCRIPTION:;Konfiguration-TOM: Bewegungsbereiche, Bewegungsteilbereiche, Zuordnung Bewegungsteilbereiche zu Bewegungsbereiche;;;;;;;
#;;;;;;;;;
>;BBE;Bewegungsbereiche;Movement Areas;;;;;;
#;Area;Descsription;;;;;;;
#;Bereich;Bezeichnung;;;;;;;
!;BBENAM;BBEBEZ;;;;;;;;
;ALLE;Alles;;;;;;;;
;SCHMAL;Schmalgang LP1;;;;;;;;
;SCHUB;Schubmast LP2;;;;;;;;
;STAPLER ALLE;Stapler Alle;;;;;;;;
;STAPLER WE ALCON;Stapler Wareneingang ALCON;;;;;;;;
;STAPLER VS ALCON;Stapler Versand ALCON;;;;;;;;
;HUBWAGEN WE ALCON;Hubwagen Wareneingang;;;;;;;;
;AMEISE WE ALCON;Ameise Wareneingang Alcon;;;;;;;;
;HUBWAGEN VS ALCON;Hubwagen Versand Alcon;;;;;;;;
;LF3 KOMMI; Kommiwagen ${BBENAM};;;;;;;;
;;;;;;;;;;
;;;;;;;;;;
;;;;;;;;;;
#;;;;;;;;;
#;;;;;;;;;
>;BTB;Bewegungsteilbereiche;Movement Subareas;;;;;;
#;Sub Area;Descsription;;;;;;;
#;Teilbereich;Bezeichnung;;;;;;;
!;BTBNAM;BTBBEZ;;;;;;;;
%;;;;;;;;;;
;EIN;${BTBNAM} - Wareneingangsfläche;;;;;;;;
#;Regale;;;;;;;;
;LP1;${BTBNAM} - Palettenlager Schmalgang;;;;;;;;
;LP2-HOCH;${BTBNAM} - Palettenlager oberene Ebenen;;;;;;;;
;LP2-10;${BTBNAM} - Palettenlager Bodenebene;;;;;;;;
;LP2-20;${BTBNAM} - Palettenlager 1. Ebene;;;;;;;;
#;Fachboden;;;;;;;;
#;LF3;;;;;;;;
;LF3-1;${BTBNAM}. Stock;;;;;;;;
;LF3-2;${BTBNAM}. Stock;;;;;;;;
;LF3-3;${BTBNAM}. Stock;;;;;;;;
;LF3-4;${BTBNAM}. Stock;;;;;;;;
#;Übergabe;;;;;;;;
;LP1-UBG;${BTBNAM} - Palettenlager Schmalgang Übergabe;;;;;;;;
;LP2-UBG;${BTBNAM} - Palettenlager Schubmast Übergabe;;;;;;;;
;LF3-UBG;${BTBNAM} - Fachboden Übergabe;;;;;;;;
#;Spezial;;;;;;;;
;KMW;${BTBNAM} - Kommissionierwagen;;;;;;;;
;ZSF;${BTBNAM} - Zusammenführung;;;;;;;;
;MTG;${BTBNAM} - Montagebereich;;;;;;;;
;TOR;${BTBNAM} - Tore;;;;;;;;
#;ZOL;${BTBNAM} - Zollbereich;;;;;;;
;VRS;${BTBNAM} - Versandbereich;;;;;;;;
;XXX;${BTBNAM} - Fehlerbereich;;;;;;;;
;XXXAP;${BTBNAM} - Klärungsplatz Abtransport;;;;;;;;
;FZG;${BTBNAM} - Fahrzeug;;;;;;;;
#;;;;;;;;;
#;;;;;;;;;
>;BBEBTB;Zuordnung Bewegungsteilbereiche zu -bereichen;Movement Subareas to Movement Areas Assignments;;;;;;
#;Movment Area;Movement Subarea;Weighting for automatic assingment of TPO (100=max, 1=min);;;;;;
#;Bewegungsbereich;Bewegungungsteilbereich;Wichtung für automatische TPA-Zuordnung (100=max, 1=min);;;;;;
!;+BBENAM;+BTBNAM;BBEBTBFUZZY;;;;;;;
%;;;100;;;;;;;
;ALLE;EIN,LP1,LP2-HOCH,LP2-10,LP2-20,LP2-20,LP1-UBG,KMW,ZSF,MRG,TOR,VRS,XXX,XXXAP,FZG;;;;;;;;
;SCHMAL;LP1-UBG, LP1;;;;;;;;
;SCHUB;EIN,LP2-HOCH,LP2-10,LP2-20,LP2-UBG;;;;;;;;
;STAPLER ALLE;EIN,LP1-UBG,ZSF,XXX,XXXAP,LP2-UBG;;;;;;;;
;STAPLER WE ALCON;EIN,LP1-UBG,XXX,XXXAP,LP2-UBG;;;;;;;;
;STAPLER VS ALCON;LP1-UBG,ZSF,XXX;;;;;;;;
;HUBWAGEN WE ALCON;LP2-10,EIN;;;;;;;;
;AMEISE WE ALCON;LP2-10,LP2-20,EIN;;;;;;;;
;HUBWAGEN VS ALCON;ZSF,VRS,TOR;;;;;;;;
;LF3;LF3-UBG,LF3-1,LF3-2,LF3-3-LF3-4;;;;;;;;

    </textarea><br />
    <button onclick="mach()">Click me</button>
  </div>
  <div id="debug" class="top">

  </div>
  <div id="out" class="top">
    <textarea id="output" rows="4" cols="60"> </textarea>
  </div>
</div>
<div id="select">

</div>
<script>

  let linecount = 0;
  let lineprocessed = 1;
  let currentTable = 'NONE';
  // Überschrift -> Zeilennummer -> Elemente
  let matrix = [];
  // Überschrift -> Zeilennummer -> Header
  let header = [];  
  let tables = [];
  let pre = [];
  let total = []; // Zeilennummer -> table/pre/matrix[type]
  let precolumncomment = [];

function debug(text, level = 0) {
    console.log(text);
  switch (level) {
    case 0:
      document.getElementById("debug").innerHTML += '<p class="hint">'+text+"</p>";
      break;
    case 1:
      document.getElementById("debug").innerHTML += '<p class="warning">'+text+"</p>";
      break;
    default:
      document.getElementById("debug").innerHTML += '<p class="error">EEEERRRROOOOORRRRRR: '+text+"</p>";
  }
  document.getElementById("debug").scrollBy(0, 100);
}

function mach() {
  // Reset variables
  linecount = 0;
  lineprocessed = 1;
  currentTable = 'NONE'
  matrix.length = 0;
  header.length = 0;
  pre.length = 0;
  total.length = 0;
  document.getElementById("select").innerHTML = "";
  // read
	result = csv_read(document.getElementById("input").value.trim());
  // Add Buttons per Headline
  tables.forEach(element => {
    debug('Add line for '+ element[1]);
    document.getElementById("select").innerHTML += '<button onclick="showtable(\''+element[1]+'\')">'+element[2]+"</button>";
  }
  );
}

function csv_read(data) {

  debug ("Starting ...");
  let lines = data.split(/\r\n|\n/);
  linecount = lines.length;
  debug("Number of Lines: " + linecount);
  for (let i=0; i<linecount; i++) {
    debug("Next Line:" + lineprocessed);
    let elements = lines[i].split(";");
    let buf = [];
    switch (elements[0]) { 

      case "#": // Comment
        debug("Type of Line: '" + elements[0] + "': Comment");
        if(currentTable == 'NONE') 
        {
          pre[i] = elements;
          total[i] = 'pre'
          break;
        } else {
          if(!matrix.includes(currentTable)) {
            matrix[currentTable] = [];
          }
          hier erstmal puffern, und dann wenn column header kommt einfügen
         // matrix[currentTable][i] = elements;
         //total[i] = currentTable;
        }
        //break;
        
      case "%": // Default-Values
        debug("Type of Line: '" + elements[0] + "': Defaults, like data");  
      case "": //Data 
        debug("Type of Line: '" + elements[0] + "': Data");
        buf = [];
        let col = 0;
        elements.forEach(element => {
          
          if(element != "" || col == 0) {
            buf[header[currentTable].find(x=>x!==undefined)[col].field] =  element ;
            col++;
          }
        } )
        matrix[currentTable][i] = buf;
        total[i] = currentTable;
      break;

      case ">": // Tables
        debug("Type of Line: '" + elements[0] + "': Table");
        currentTable = elements[1];
        debug("Set Table to " + currentTable);
        tables[i] = elements;
        total[i] = 'table';

        break;

      case "!": // Columnheader
        debug("Type of Line: '" + elements[0] + "': Lineheader");
        if(!header.includes(currentTable)) {
            header[currentTable] = [];
        }
        let buffer = [];
        elements.forEach(element => {
          if(element != "") 
          buffer.push( {'field' : element} );
        } )
        header[currentTable][i] = buffer;
        total[i] = currentTable;
        break;
     
      default:
        debug("Type of Line: '" + elements[0] + "': UNDEFINED!");
        break;

    }

    lineprocessed += 1;
  }
}

function showtable(tablename) {
  
  debug("Drawing table for "+tablename);
  let columns = header[tablename].find(x=>x!==undefined);
  debug("Headers defined");
}
</script>

</body>
</html>